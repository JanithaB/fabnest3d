name: Deploy to Production (EC2)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Deploy Application to EC2
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            set -e
            echo "Navigating to application directory..."
            cd ${{ secrets.APP_DIR }}

            echo "Pulling latest changes from main branch..."
            git pull origin main

            echo "Installing dependencies..."
            pnpm install

            echo "Cleaning previous builds..."
            pnpm run clean

            echo "Building the application..."
            if pnpm run build; then
              echo "Build succeeded. Restarting PM2 service..."
              pm2 restart fabnest3d
            else
              echo "Build failed. Exiting deployment."
              exit 1
            fi

            echo "Deployment completed successfully."
